# 11人制足球战术对抗数据模型（状态机实现版 v2）

本文档是可直接编码实现的统一规范，基于当前状态机逻辑，整合阵型参数、策略参数、区域对抗、事件回流、射门分解与AIGC解说输入。

---

## 1. 目标与范围

- 以状态机驱动90分钟比赛仿真。
- 在每个时间片输出球权、区域、事件、射门与进球结果。
- 支持阵型调整、策略叠加、攻防转换、定位球事件。
- 产出可追溯事件流供AIGC解说与赛后复盘使用。

---

## 2. 状态机定义

### 2.1 状态变量

- 球权：`P in {A, B}`
- 区域：`Z in {DZ_L, DZ_C, DZ_R, MC_L, MC_C, MC_R, AT_L, AT_C, AT_R, BA_L, BA_C, BA_R, PA}`
- 时间片：`t_k`（建议1分钟或5分钟）
- 状态：`S_k = (P_k, Z_k, t_k)`

### 2.2 事件优先级

1. 犯规（Foul -> FreeKick/Penalty）
2. 射门（Shot）
3. 出界/角球（Out/Corner）
4. 推进/转移/失误（Advance/Switch/Loss）
5. 原地控球（Hold）

### 2.3 英文变量中文释义（完整）

| 英文标识 | 中文含义 |
| --- | --- |
| `P` | 球权方（A队或B队） |
| `Z` | 球所在区域 |
| `t_k` | 第k个时间片 |
| `S_k` | 第k个状态（球权+区域+时间片） |
| `Foul` | 犯规事件 |
| `FreeKick` | 任意球事件 |
| `Penalty` | 点球事件 |
| `Shot` | 射门事件 |
| `Out` | 出界事件 |
| `Corner` | 角球事件 |
| `Hold` | 原地控球/节奏停留 |
| `F` | 阵型8维特征向量 |
| `F'` | 叠加策略后的阵型特征向量 |
| `alpha_i` | 第i个策略强度系数 |
| `DeltaF_i` | 第i个策略对8维特征的偏移 |
| `DeltaRisk_i` | 第i个策略对风险值的偏移 |
| `Risk` | 进攻风险偏好系数 |
| `W_form` | 阵型左中右路线倾向权重 |
| `W_form_base` | 阵型先验路线倾向权重 |
| `W_form_dyn` | 当前时间片动态路线倾向权重 |
| `W_route_eff` | 叠加通道疲劳后的有效路线权重 |
| `DeltaW_route` | 策略对路线倾向的修正向量 |
| `LaneStreak` | 连续命中同一通道的计数器 |
| `k_lane_fatigue` | 通道疲劳系数（同路降权强度） |
| `W_excl` | 排除当前通道后的重采样权重 |
| `W_attack` | 区域进攻能力映射权重 |
| `W_defense` | 区域防守能力映射权重 |
| `C_attack(zone)` | 在某区域的进攻能力评分 |
| `C_defense(zone)` | 在某区域的防守能力评分 |
| `adv1~adv5` | 五类结构对抗优势项 |
| `w_i` | 对抗优势项权重 |
| `M(A->B)` | A队对B队进攻修正系数 |
| `F_build` | 后场组织成功因子 |
| `F_progress` | 中前场推进成功因子 |
| `F_entry` | 进入危险区成功因子 |
| `F_transition` | 攻防转换效率因子 |
| `F_disrupt` | 被对手破坏/打断因子 |
| `P_advance` | 纵向推进概率 |
| `P_switch` | 横向转移概率 |
| `P_loss` | 失误丢失球权概率 |
| `MirrorTurnover(Z)` | 球权交换时的区域镜像映射函数 |
| `LevelMap_loss` | 失误后区域层级映射规则 |
| `LaneMap_loss` | 失误后左右路翻转规则 |
| `ShotRate` | 时间片射门强度 |
| `ShotProb` | 时间片至少一次射门概率 |
| `ShotQuality` | 射门质量（近似xG质量项） |
| `Lambda` | 时间片进球率参数 |
| `BaseShots` | 阵型与节奏决定的基础射门基数 |
| `BaseXG` | 区域与机会类型决定的基础xG |
| `DeltaT` | 当前时间片时长 |
| `DefReaction` | 防守整体反应能力（含回追与封堵） |
| `GK` | 门将扑救能力参数 |
| `P_goal` | 进球概率 |
| `P_block` | 被防守球员封堵概率 |
| `P_save` | 被门将扑救概率 |
| `ShotType` | 射门类型标签 |
| `TypeBonus` | 射门类型对射门质量的增益 |
| `TypeDefense` | 射门类型带来的额外防守修正 |
| `P_penalty` | 点球触发概率 |
| `P_freekick` | 任意球触发概率 |
| `P_foul` | 犯规基础触发概率 |
| `P_shot` | 射门事件触发概率 |
| `P_out` | 出界事件触发概率 |
| `LastTouchDefender` | 出界前最后触球方是否为防守方 |
| `OutGate(Z)` | 出界区域门控函数（仅贴边区域触发） |
| `ThrowInMap(level)` | 界外球重启层级映射函数 |
| `EdgeOut` | 出界边信息（左边线/右边线/底线） |
| `P_event` | 事件层总概率 |
| `P_flow` | 流转层总概率 |
| `P_hold` | 原地控球停留概率 |
| `WallQuality_auto` | 自动推导的人墙质量 |
| `WallPositionFit_auto` | 自动推导的人墙站位匹配度 |
| `GKPosition_auto` | 自动推导的门将站位质量 |
| `WallFactor` | 人墙综合影响因子 |
| `AngleFit(FKZone)` | 任意球区域与射门角度匹配函数 |
| `FKZone` | 任意球发生区域标签 |
| `P_goal_raw` | 归一化前进球概率分量 |
| `P_block_raw` | 归一化前封堵概率分量 |
| `P_save_raw` | 归一化前扑救概率分量 |
| `P_goal_pen` | 点球场景进球概率 |
| `P_save_pen` | 点球场景扑救概率 |
| `P_miss_pen` | 点球场景罚失概率 |
| `beta_ij` | 策略i与策略j的交互强度系数 |
| `Gamma_ij` | 策略i与策略j的交互方向向量（8维） |
| `betaRisk_ij` | 策略i与策略j对风险项的交互系数 |
| `sigmoid` | S形映射函数，将实数压缩到0到1 |
| `clamp` | 截断函数，将值限制在指定区间 |
| `PenTaker` | 点球主罚者能力参数 |
| `GKPenalty` | 门将点球防守能力参数 |

---

## 3. 基础特征与参数表

### 3.1 阵型8维特征

`F = [AW, DW, CN, HS, PR, BS, TR, BU]`，取值范围`[0,1]`。

| 变量 | 中文含义 |
| --- | --- |
| `AW` | 进攻宽度 |
| `DW` | 防守宽度覆盖 |
| `CN` | 中路人数优势 |
| `HS` | 肋部控制能力 |
| `PR` | 逼抢强度基线 |
| `BS` | 防线稳固性 |
| `TR` | 攻防转换速度 |
| `BU` | 出球与组织能力 |

| 阵型 | AW | DW | CN | HS | PR | BS | TR | BU |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 4-4-2 | 0.65 | 0.70 | 0.55 | 0.45 | 0.55 | 0.70 | 0.70 | 0.55 |
| 4-4-1-1 | 0.62 | 0.72 | 0.60 | 0.50 | 0.55 | 0.72 | 0.65 | 0.60 |
| 4-3-3 | 0.80 | 0.62 | 0.55 | 0.55 | 0.70 | 0.55 | 0.70 | 0.62 |
| 4-2-3-1 | 0.70 | 0.70 | 0.65 | 0.60 | 0.62 | 0.70 | 0.60 | 0.70 |
| 4-1-4-1 | 0.68 | 0.72 | 0.62 | 0.55 | 0.58 | 0.74 | 0.58 | 0.62 |
| 4-3-2-1 | 0.55 | 0.68 | 0.75 | 0.72 | 0.60 | 0.68 | 0.55 | 0.72 |
| 4-2-2-2 | 0.58 | 0.65 | 0.70 | 0.72 | 0.62 | 0.66 | 0.62 | 0.68 |
| 4-4-2钻石 | 0.50 | 0.60 | 0.78 | 0.70 | 0.60 | 0.65 | 0.62 | 0.70 |
| 3-5-2 | 0.70 | 0.65 | 0.70 | 0.60 | 0.60 | 0.68 | 0.62 | 0.65 |
| 3-4-3 | 0.78 | 0.55 | 0.55 | 0.60 | 0.68 | 0.55 | 0.72 | 0.58 |
| 3-4-1-2 | 0.62 | 0.60 | 0.70 | 0.65 | 0.62 | 0.62 | 0.60 | 0.68 |
| 5-3-2 | 0.55 | 0.78 | 0.62 | 0.55 | 0.45 | 0.82 | 0.60 | 0.50 |
| 5-4-1 | 0.45 | 0.82 | 0.58 | 0.48 | 0.40 | 0.85 | 0.55 | 0.45 |
| 2-3-5 | 0.85 | 0.40 | 0.60 | 0.55 | 0.65 | 0.35 | 0.75 | 0.55 |
| WM(3-2-2-3) | 0.70 | 0.55 | 0.60 | 0.55 | 0.55 | 0.55 | 0.65 | 0.55 |
| 4-2-4 | 0.82 | 0.50 | 0.55 | 0.55 | 0.60 | 0.50 | 0.75 | 0.52 |
| 5-3-2链式防守 | 0.50 | 0.85 | 0.60 | 0.50 | 0.35 | 0.90 | 0.58 | 0.45 |
| 4-6-0 | 0.60 | 0.70 | 0.80 | 0.75 | 0.70 | 0.60 | 0.55 | 0.78 |
| 4-3-3伪九号 | 0.75 | 0.60 | 0.65 | 0.70 | 0.70 | 0.55 | 0.68 | 0.75 |
| 3-3-3-1 | 0.68 | 0.58 | 0.70 | 0.65 | 0.65 | 0.58 | 0.65 | 0.65 |

### 3.2 策略基准偏移表（alpha=1）

`F' = clamp(F + Σ alpha_i * DeltaF_i, 0, 1)`

其中：
- `alpha_i`：第i个策略的强度系数（0~1）
- `DeltaF_i`：第i个策略对8维特征的偏移向量
- `DeltaRisk_i`：第i个策略对风险系数的偏移值
- `clamp`：将结果截断在`[0,1]`区间

| 策略 | DeltaAW | DeltaDW | DeltaCN | DeltaHS | DeltaPR | DeltaBS | DeltaTR | DeltaBU | DeltaRisk |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 默认平衡（Initial/Balanced） | +0.00 | +0.00 | +0.00 | +0.00 | +0.00 | +0.00 | +0.00 | +0.00 | +0.00 |
| 前压 | +0.05 | -0.05 | +0.05 | +0.05 | +0.12 | -0.08 | +0.05 | -0.02 | +0.12 |
| 后撤 | -0.05 | +0.08 | +0.02 | -0.02 | -0.10 | +0.12 | -0.05 | -0.02 | -0.10 |
| 深度防守 | -0.05 | +0.10 | +0.03 | -0.03 | -0.18 | +0.15 | -0.05 | -0.05 | -0.12 |
| 控球推进 | -0.02 | +0.03 | +0.08 | +0.06 | -0.02 | +0.02 | -0.08 | +0.18 | -0.03 |
| 快速反击 | +0.05 | -0.02 | -0.02 | -0.02 | +0.05 | -0.05 | +0.18 | -0.08 | +0.06 |
| 边路倾斜 | +0.18 | +0.02 | -0.05 | -0.08 | +0.02 | -0.02 | +0.05 | -0.02 | +0.03 |
| 中路渗透 | -0.08 | -0.02 | +0.15 | +0.12 | +0.02 | -0.02 | +0.02 | +0.05 | +0.04 |

初始策略规则：

- 开场前若未下发任何战术口令，默认启用`Initial/Balanced`。
- `Initial/Balanced`不参与互斥判定，也不参与双策略交互项（`beta_ij`, `Gamma_ij`）。
- 当仅有`Initial/Balanced`生效时，`F' = F`，`Risk' = Risk`，`W_form_dyn = W_form_base`。

### 3.2.1 策略关系（互斥/协同/冲突）

互斥组（同一时间仅保留一个）：

- 比赛高度组：`前压`、`后撤`、`深度防守`
- 节奏组：`控球推进`、`快速反击`
- 主攻通道组：`边路倾斜`、`中路渗透`

可协同的常见组合（同一时间可叠加）：

- `深度防守 + 快速反击`：降低阵地战风险，提升抢断后的纵向推进速度
- `控球推进 + 中路渗透`：中场持球稳定性增强，提升中路连续配合成功率
- `边路倾斜 + 快速反击`：边路推进速度提升，提升边路传中与后点终结机会
- `前压 + 边路倾斜`：压上配合边路宽度，提升边路快速压制与传中频次

冲突组合（允许但建议降低强度）：

- `前压 + 控球推进`：前者强调压迫速度，后者强调控球耐心，节奏目标冲突
- `前压 + 深度防守`：站位高度目标相反，导致前后场联动效率下降
- `后撤 + 快速反击`：若后撤过深会拉长反击距离，削弱第一时间出球效率

### 3.2.2 双策略交互修正（两策略叠加时）

当同一时间片启用两个非互斥策略`i, j`时，建议使用：

- `F'' = clamp(F + alpha_i*DeltaF_i + alpha_j*DeltaF_j + beta_ij*alpha_i*alpha_j*Gamma_ij, 0, 1)`
- `Risk'' = clamp(Risk + alpha_i*DeltaRisk_i + alpha_j*DeltaRisk_j + betaRisk_ij*alpha_i*alpha_j, 0, 1)`

其中`beta_ij > 0`表示协同，`beta_ij < 0`表示冲突惩罚。

建议交互参数（示例）：

| 策略对 | beta_ij | betaRisk_ij | 交互方向说明 |
| --- | --- | --- | --- |
| 深度防守 + 快速反击 | +0.10 | +0.02 | 提升`TR`并保持`BS`稳定 |
| 控球推进 + 中路渗透 | +0.10 | -0.02 | 提升`CN/BU/HS`并降低盲目前插 |
| 边路倾斜 + 快速反击 | +0.08 | +0.05 | 提升`AW/TR`，同时提高丢失后风险 |
| 前压 + 边路倾斜 | +0.07 | +0.06 | 提升`AW/PR/TR`，加强压上后的边路输出 |
| 前压 + 控球推进 | -0.08 | +0.03 | 节奏冲突，削弱`TR`增益 |
| 前压 + 深度防守 | -0.12 | -0.01 | 高度冲突，削弱`PR`实际转化效率 |

### 3.2.3 各策略对核心过程指标影响（方向性）

符号说明：`++`显著提升，`+`提升，`0`中性，`-`下降，`--`显著下降。
表格视角为“进攻执行方A”，`P_block(对手)`与`P_save(对手)`表示A队射门被防守成功的概率变化方向。

| 策略 | P_advance | P_switch | P_loss | ShotRate | ShotQuality | P_block(对手) | P_save(对手) |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 前压 | + | 0 | + | + | 0 | + | + |
| 后撤 | - | 0 | - | - | 0 | - | - |
| 深度防守 | - | 0 | - | - | 0 | - | - |
| 控球推进 | + | + | -- | 0 | + | - | - |
| 快速反击 | ++ | - | + | + | + | 0 | 0 |
| 边路倾斜 | + | ++ | + | + | 0 | + | 0 |
| 中路渗透 | + | - | + | + | ++ | 0 | + |

建模建议：

- `P_advance`主要受`TR/BU/AW/HS`正向影响，受对手`PR/BS`负向影响。
- `P_switch`主要受`BU/HS`正向影响，受对手`PR`负向影响。
- `P_loss`主要受对手`PR/BS`正向影响，受本方`BU/TR`负向影响。
- `ShotRate`受`F_progress/F_transition`驱动更明显；`ShotQuality`受`F_entry`驱动更明显。
- `P_block`与防守压迫和人墙/站位质量相关；`P_save`与门将参数和防线保护相关。

### 3.3 路线倾向矩阵（先验）

用于左/中/右路线选择，记为`W_form = [W_L, W_C, W_R]`。

| 阵型 | W_L | W_C | W_R |
| --- | --- | --- | --- |
| 4-4-2 | 0.34 | 0.32 | 0.34 |
| 4-4-1-1 | 0.32 | 0.36 | 0.32 |
| 4-3-3 | 0.40 | 0.20 | 0.40 |
| 4-2-3-1 | 0.32 | 0.36 | 0.32 |
| 4-1-4-1 | 0.31 | 0.38 | 0.31 |
| 4-3-2-1 | 0.24 | 0.52 | 0.24 |
| 4-2-2-2 | 0.28 | 0.44 | 0.28 |
| 4-4-2钻石 | 0.22 | 0.56 | 0.22 |
| 3-5-2 | 0.35 | 0.30 | 0.35 |
| 3-4-3 | 0.38 | 0.24 | 0.38 |
| 3-4-1-2 | 0.30 | 0.40 | 0.30 |
| 5-3-2 | 0.33 | 0.34 | 0.33 |
| 5-4-1 | 0.28 | 0.44 | 0.28 |
| 2-3-5 | 0.42 | 0.16 | 0.42 |
| WM(3-2-2-3) | 0.34 | 0.32 | 0.34 |
| 4-2-4 | 0.41 | 0.18 | 0.41 |
| 5-3-2链式防守 | 0.26 | 0.48 | 0.26 |
| 4-6-0 | 0.24 | 0.52 | 0.24 |
| 4-3-3伪九号 | 0.35 | 0.30 | 0.35 |
| 3-3-3-1 | 0.33 | 0.34 | 0.33 |
| 其他阵型默认 | 0.33 | 0.34 | 0.33 |

### 3.3.1 主攻通道策略对路线倾向的动态修正

先验路线权重记为`W_form_base = [W_L, W_C, W_R]`。  
当策略生效时，实时路线权重改为：

- `W_form_dyn = normalize(clamp(W_form_base + Σ(alpha_i * DeltaW_route_i), 0.05, 0.90))`

其中`normalize`保证`W_L + W_C + W_R = 1`。

主攻通道组建议修正向量：

| 策略 | DeltaW_route（L,C,R） |
| --- | --- |
| 边路倾斜 | `( +0.12, -0.24, +0.12 )` |
| 中路渗透 | `( -0.10, +0.20, -0.10 )` |

配套策略的轻量修正（可选）：

| 策略 | DeltaW_route（L,C,R） |
| --- | --- |
| 快速反击 | `( +0.04, -0.08, +0.04 )` |
| 控球推进 | `( -0.03, +0.06, -0.03 )` |

实现约束：

- 若同时间片出现互斥通道策略（`边路倾斜`与`中路渗透`），只保留最终生效策略。
- `W_form_dyn`用于同层横向转移、门将开球落点分配、反击起始通道选择。
- 若无相关策略生效，则`W_form_dyn = W_form_base`。

### 3.3.2 通道疲劳与同路重采样

为避免“连续选择同一路导致表面转移但实际停留”，在`W_form_dyn`上再叠加通道疲劳，得到本时间片的有效路线权重：

- `W_route_eff = normalize(W_form_dyn * FatigueMask)`
- `FatigueMask[current_lane] = exp(-k_lane_fatigue * LaneStreak)`
- `FatigueMask[other_lanes] = 1.0`

建议参数：

- `k_lane_fatigue = 0.6`（可在`0.4~0.8`调参）
- `LaneStreak`在“目标通道=当前通道”时递增，否则归零
- 当时间片结束后球权发生变化时，`LaneStreak`强制归零（避免把上一支球队的通道惯性传递给对手）

同路重采样规则（用于横向转移）：

- 若`target_lane == current_lane`，则不直接执行横向转移；
- 改为在其余两个通道按`W_excl`重采样：
- `W_excl[l] = W_route_eff[l] / (1 - W_route_eff[current_lane]) , l != current_lane`
- `W_excl[current_lane] = 0`
- 当分母接近0时，退化为在另两路均匀采样。

该规则只改变“横向转移的落点通道”，不改变`P_switch`本身。

### 3.4 区域映射权重（9区）

计算区域攻防能力：

- `C_attack(zone) = sigmoid(W_attack(zone) · F')`
- `C_defense(zone) = sigmoid(W_defense(zone) · F')`

攻击权重示例：

| 区域 | AW | CN | HS | TR | BU |
| --- | --- | --- | --- | --- | --- |
| DZ_L | 0.10 | 0.10 | 0.10 | 0.05 | 0.25 |
| DZ_C | 0.05 | 0.15 | 0.15 | 0.05 | 0.30 |
| DZ_R | 0.10 | 0.10 | 0.10 | 0.05 | 0.25 |
| MC_L | 0.20 | 0.10 | 0.15 | 0.10 | 0.20 |
| MC_C | 0.10 | 0.25 | 0.25 | 0.05 | 0.15 |
| MC_R | 0.20 | 0.10 | 0.15 | 0.10 | 0.20 |
| AT_L | 0.30 | 0.10 | 0.20 | 0.10 | 0.10 |
| AT_C | 0.10 | 0.30 | 0.30 | 0.10 | 0.05 |
| AT_R | 0.30 | 0.10 | 0.20 | 0.10 | 0.10 |

防守权重示例：

| 区域 | DW | CN | PR | BS | TR |
| --- | --- | --- | --- | --- | --- |
| DZ_L | 0.10 | 0.05 | 0.10 | 0.25 | 0.05 |
| DZ_C | 0.05 | 0.10 | 0.15 | 0.30 | 0.05 |
| DZ_R | 0.10 | 0.05 | 0.10 | 0.25 | 0.05 |
| MC_L | 0.20 | 0.10 | 0.20 | 0.15 | 0.10 |
| MC_C | 0.10 | 0.15 | 0.25 | 0.20 | 0.15 |
| MC_R | 0.20 | 0.10 | 0.20 | 0.15 | 0.10 |
| AT_L | 0.25 | 0.05 | 0.20 | 0.15 | 0.10 |
| AT_C | 0.10 | 0.10 | 0.25 | 0.20 | 0.10 |
| AT_R | 0.25 | 0.05 | 0.20 | 0.15 | 0.10 |

---

## 4. 对抗与过程公式

### 4.1 结构对抗优势

- `adv1 = AW_A' - (DW_B' + BS_B')/2`
- `adv2 = (CN_A' + BU_A')/2 - (CN_B' + PR_B')/2`
- `adv3 = (HS_A' + BU_A')/2 - (CN_B' + BS_B')/2`
- `adv4 = (Risk_A' - BS_A') - TR_B'`
- `adv5 = BU_A' - PR_B'`

`M(A->B) = clamp(0.7 + 0.6 * Σ(w_i * adv_i), 0.4, 1.4)`

其中：
- `adv1~adv5`：五个对抗维度的优势分
- `w_i`：各维度权重（建议总和为1）
- `M(A->B)`：A队进攻B队时的进攻修正系数

### 4.2 过程因子

- `F_build = sigmoid(BU_A' - PR_B')`
- `F_progress = sigmoid(0.6*AW_A' + 0.4*HS_A' - (0.6*DW_B' + 0.4*BS_B'))`
- `F_entry = sigmoid(0.5*CN_A' + 0.5*HS_A' - BS_B')`
- `F_transition = sigmoid(TR_A' + Risk_A' - BS_B')`
- `F_disrupt = sigmoid(PR_B' + BS_B' - (BU_A' + TR_A'))`

### 4.3 区域转移概率

- `P_advance = sigmoid(Z_adv)`
- `P_switch = sigmoid(0.5*BU + 0.5*HS - 0.5*PR_opponent + RouteBias)`
- `P_loss = sigmoid(PR_opponent + BS_opponent - (BU + TR))`

其中：

- `RouteBias = k_route * (W_route_eff[target_lane] - 1/3)`，`k_route`建议取`0.15~0.25`
- 当目标通道是当前策略偏好的通道时，`RouteBias > 0`，横向切换更容易成功

目标通道采样建议（与实现一致）：

- 先由`W_route_eff`采样得到`target_lane`
- 若命中“横向转移”且`target_lane == current_lane`，执行“同路重采样”
- 重采样后的通道作为`P_switch`的最终落点
- 若`zone.level = PA`，建议增加推进门控：`AdvanceGate=0`，即禁止继续纵向推进

终结区（`BA/PA`）概率偏置建议：

- `P_switch' = P_switch * SwitchEndzoneFactor(level)`  
  建议：`DZ=1.00, MC=1.00, AT=0.92, BA=0.68, PA=0.50`
- `P_hold`向射门事件回灌：  
  `delta_shot = P_hold * HoldToShotRatio(level)`  
  `P_shot' = clamp(P_shot + delta_shot, 0, P_shot_cap)`  
  `P_hold' = P_hold - (P_shot' - P_shot)`  
  建议：`DZ=0.00, MC=0.00, AT=0.05, BA=0.28, PA=0.42`

解释：

- 进入禁区前沿/禁区后，减少无效横传和原地停留；
- 把一部分停留概率转化为射门触发概率，符合真实比赛“终结优先”的行为。

其中：
- `P_advance`：纵向推进到下一层区域的概率
- `P_switch`：同层左右/中路横向转移概率
- `P_loss`：失误导致球权转换的概率

### 4.4 失误球权转换区域镜像规则

当`P_loss`命中且球权交换时，状态更新为：

- `(P, Z) -> (P_opp, MirrorTurnover(Z))`

其中镜像函数定义为：

- `MirrorTurnover(Z) = (LevelMap_loss(level), LaneMap_loss(lane))`
- `LaneMap_loss`: `L->R, C->C, R->L`

`LevelMap_loss`采用“稳健反击”版本（避免中场断球直接跳到禁区前沿）：

| 原区域层级 | 交换后层级 | 说明 |
| --- | --- | --- |
| `DZ` | `AT` | 后场被断后，对手在前场形成压制 |
| `MC` | `MC` | 中场失误后仍在中场攻防转换 |
| `AT` | `MC` | 前场被断后，对手先在中场组织 |
| `BA` | `AT` | 禁区前沿被断后，对手在前场继续推进 |
| `PA` | `DZ` | 禁区内失误后，对手从后场方向重新组织 |

示例：

- `PA_R -> DZ_L`（禁区右路失误后，球权方切换并镜像到后场左路）
- `MC_C -> MC_C`（中场中路失误后仍在中场中路）
- `AT_L -> MC_R`（前场左路失误后镜像到中场右路）

同一规则也用于“二点争抢/脱手球”场景：若最终控球方发生交换，区域按`MirrorTurnover(Z)`处理。

---

## 5. 射门模型

### 5.1 射门概率与进球率

- `ShotRate = BaseShots * (0.4*F_build + 0.4*F_progress + 0.2*F_transition) * (1 - F_disrupt)`
- `ShotProb = 1 - exp(-ShotRate * DeltaT)`
- `P_shot = clamp(ShotProb * ZoneMul(level) * ZoneShotGate(level) * LaneShotGate(lane), 0, 1)`
- `ShotQuality = BaseXG * (0.6*F_entry + 0.4*F_progress)`
- `Lambda = ShotRate * ShotQuality * M(A->B)`

其中：
- `ShotRate`：当前时间片射门发生强度
- `ShotProb`：当前时间片至少一次射门概率
- `P_shot`：当前时间片触发“射门事件”的概率（已含区域与通道门控）
- `ShotQuality`：射门质量（近似xG质量项）
- `Lambda`：当前时间片进球率参数

区域/通道门控建议值（当前实现）：

| 项 | DZ | MC | AT | BA | PA |
| --- | --- | --- | --- | --- | --- |
| `ZoneMul(level)` | 0.45 | 0.65 | 1.00 | 1.25 | 1.45 |
| `ZoneShotGate(level)` | 0.06 | 0.14 | 0.38 | 0.72 | 1.00 |
| `ShotEndzoneBoost(level)` | 1.00 | 1.00 | 1.00 | 1.18 | 1.30 |

`LaneShotGate(lane)`：

- 左路 `L` = `0.88`
- 中路 `C` = `1.00`
- 右路 `R` = `0.88`

解释：

- `ZoneMul`体现“越靠近球门，射门倾向越强”。
- `ZoneShotGate`用于压制中后场超远距离射门频率。
- `LaneShotGate`让中路射门略高于边路，符合常见射门角度规律。

### 5.2 射门结果分解

- `P_goal_raw = sigmoid(1.2*ShotQuality - 0.8*DefReaction)`
- `P_block_raw = sigmoid(0.6*PR_B + 0.4*BS_B - 0.6*HS_A)`
- `P_save_raw = sigmoid(0.7*BS_B + 0.6*GK - 0.5*ShotQuality)`
- 归一化后得到`P_goal, P_block, P_save`

### 5.3 常用射门类型参数（可扩展）

| ShotType | TypeBonus | TypeDefense |
| --- | --- | --- |
| Long | -0.08 | +0.05 |
| Box | +0.00 | +0.00 |
| BigChance | +0.12 | -0.05 |
| Header | -0.02 | -0.02 |
| SetPiece | +0.05 | +0.00 |
| Penalty | +0.18 | -0.10 |
| Rebound | +0.10 | -0.05 |
| LowDrive | +0.07 | -0.03 |
| Finesse | +0.06 | +0.02 |
| CornerShot | -0.04 | +0.06 |
| CurledFK | +0.06 | +0.02 |
| KnuckleFK | +0.04 | +0.05 |

`ShotQuality' = ShotQuality + TypeBonus`

---

## 6. 事件机制与回流规则

### 6.1 概率闭环

- `P_penalty = P_foul * I(Z = PA)`
- `P_freekick = P_foul * I(Z != PA)`
- `P_event = P_penalty + P_freekick + P_shot + P_out`
- `P_flow = P_advance + P_switch + P_loss`
- `P_hold = 1 - P_event - P_flow`

其中：
- `P_penalty`：点球触发概率（仅禁区内犯规）
- `P_freekick`：任意球触发概率（非禁区内犯规）
- `P_event`：事件层总概率（犯规/射门/出界）
- `P_flow`：流转层总概率（推进/转移/失误）
- `P_hold`：无事件且无流转时的停留概率

角球为条件派生事件：出底线且最后触球方为防守方时触发，不单独并入`P_event`。

### 6.2 出界

当前实现采用“通道级”出界重启（按左/中/右通道），规则如下：

0) 先做出界门控：

- `OutGate(Z)=1` 才允许触发`Out`
- `OutGate(Z)=0` 时强制 `P_out=0`
- 当前门控定义：`lane in {L,R}` 或 `level in {BA,PA}`  
  含义：仅贴近边线/底线的区域允许出界判定；例如`MC_C`不允许直接触发出界

1) 先判最后触球方：

- `LastTouchDefender = True`：防守方最后触球
- `LastTouchDefender = False`：进攻方最后触球

2) 再判是否底线触发角球：

- 若`Z in {BA, PA}`且`LastTouchDefender=True`，触发角球（`6.3`）
- 其余情况进入“界外球重启”

3) 界外球重启状态更新：

- 若`LastTouchDefender=True`：原进攻方发界外球  
  `(P, Z=(level, lane)) -> (P, (ThrowInMap(level), lane))`
- 若`LastTouchDefender=False`：球权交换后发界外球  
  `(P, Z=(level, lane)) -> (P_opp, (ThrowInMap(level_m), lane_m))`  
  其中`(level_m, lane_m)=MirrorTurnover((level, lane))`

4) `ThrowInMap(level)`（当前实现）：

| level | ThrowInMap(level) | 说明 |
| --- | --- | --- |
| `DZ` | `DZ` | 后场出界后在后场重启 |
| `MC` | `MC` | 中场出界后在中场重启 |
| `AT` | `AT` | 前场边路出界后在前场重启 |
| `BA` | `AT` | 禁区前沿出界回落到前场重启 |
| `PA` | `AT` | 禁区出界回落到前场重启 |

关于“哪条边”的控制逻辑：

- 当前版本是“通道级控制”，即用`lane in {L,C,R}`表达左/中/右侧重启，不追踪具体几何边线坐标。
- 因此会有“左路/中路/右路”的重启差异，但不会区分“左边线第几米”或“右边线第几米”。
- 若后续需要精细化，可新增`EdgeOut in {LeftTouchline, RightTouchline, GoalLine}`并增加重启坐标`(x_restart, y_restart)`，把“边线类型”与“落点坐标”分离建模。

### 6.3 角球

- 触发：`BA/PA`出底线且最后触球防守方
- 开球区域：`BA_L`或`BA_R`
- 首轮分流：
- 进攻方第一点占优 -> `PA/BA`二次进攻
- 防守方第一点占优 -> 回落`AT/MC`
- 直接攻门 -> `ShotType=CornerShot`

### 6.4 任意球

- 触发：`P_freekick`
- 回流：`(P, Z) -> (P, Z 或 Z+1)`
- 执行分流：直接攻门/传中做球/短传重启
- 直接攻门时防守修正（自动推导）：
- `WallQuality_auto = clamp(0.55*BS_B + 0.30*PR_B + 0.15*DW_B, 0, 1)`
- `WallPositionFit_auto = clamp(0.50*DW_B + 0.30*PR_B + 0.20*AngleFit(FKZone), 0, 1)`
- `GKPosition_auto = clamp(0.60*BS_B + 0.40*PR_B, 0, 1)`
- `WallFactor = 0.6*WallQuality_auto + 0.4*WallPositionFit_auto`
- `P_block' = clamp(P_block + 0.20*WallFactor, 0, 1)`
- `P_save' = clamp(P_save + 0.15*GKPosition_auto + 0.05*WallFactor, 0, 1)`

### 6.5 点球

- 触发：`P_penalty`（仅`Z=PA`）
- 射门类型固定：`ShotType=Penalty`
- 概率示例：
- `PenTaker = clamp(0.6*BU_A + 0.4*HS_A, 0, 1)`
- `GKPenalty = clamp(0.5*BS_B + 0.5*PR_B, 0, 1)`
- `P_goal_pen, P_save_pen, P_miss_pen`归一化求得
- 回流：进球后`MC_C`开球；扑救控制回`DZ/MC`；脱手回`PA/BA`；罚失回`DZ/MC`

---

## 7. 守门员防守结果分流

在射门后非进球场景，按以下结果回流：

- 控制成功：默认`P(MC)=0.70, P(DZ)=0.30`，再按控球方`W_form`分配到左中右
- 解围成功：球到`AT/MC`争抢
- 二次球：球留在`PA/BA`
- 定位球派生：防守触球后出界 -> 角球/界外球

---

## 8. 90分钟流程控制

### 8.1 阵型与策略调整

- 阵型调整节点：开场前、15'、30'、45'、60'、75'（共6次）
- 每次阵型调整后可进行2次策略调整
- 允许叠加2个不互斥策略；互斥策略直接替换

### 8.2 单时间片执行顺序

1. 读取当前状态`S_k`
2. 计算策略修正`F', Risk'`
3. 计算`W_form_dyn`并叠加通道疲劳得到`W_route_eff`
4. 计算对抗系数`M`和过程因子
5. 分配`P_event`并优先处理事件回流
6. 若无事件，执行`P_flow`（推进/转移/失误）
7. 若命中横向转移且目标通道=当前通道，执行同路重采样
8. 若触发射门，进入射门类型与结果分解
9. 更新`S_(k+1)`、`LaneStreak`并记录事件

---

## 9. AIGC输入与输出

### 9.1 AIGC输入

- 阵型与策略
- 区域状态与球权
- 事件流（犯规、角球、任意球、点球、射门）
- 概率指标（ShotProb、Lambda、P_goal等）

### 9.2 AIGC输出

- 实时态势解说
- 优势来源与风险提示
- 战术调整建议
- 关键事件回顾
- 赛后复盘摘要

---

## 10. 实现建议

- 时间片建议先用`1分钟`，后续再做`5分钟`压缩对比。
- 所有概率统一`clamp`并做归一化，避免越界。
- 日志结构固定为：`time, possession, zone, event, shot_type, result, xg, score`。
- 建议新增日志字段：`route_raw, route_eff, lane_streak, resample_hit`，用于校验“疲劳与重采样”是否生效。
- 先实现核心射门类型，再按需求扩展类型库。
