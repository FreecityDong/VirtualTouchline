# VirtualTouchline 使用手册

## 1. 功能概览

`fusion_pygame_simulator.py` 是手势驱动的足球战术模拟器，支持：

- 比赛推进（手动/自动/快速快进）
- A 队阵型手势确认与策略手势调整
- 时间窗配额限制（阵型/策略）
- 中场与终场战术报告弹窗
- 比赛日志与统计看板

## 2. 启动方式

在项目根目录执行：

```bash
python3 fusion_pygame_simulator.py
```

如果使用虚拟环境：

```bash
source .venv_gesture/bin/activate && python3 fusion_pygame_simulator.py
```

## 3. 界面说明

- 左侧：球场、球员、手势光标、底部操作按钮
- 中间（球场图右侧窄条）：策略区
  - 上半：`A队策略`（可编辑）
  - 下半：`B队策略`（自动调整，只读）
- 右侧：摄像头画面、配额/统计、比赛日志

## 4. 键盘操作

- `Space`：开始/暂停自动推进
- `N`：手动推进 15 秒比赛时间
- `M`：从当前时间快速模拟到下一阶段
  - `<45:00` -> 快进到 `45:00`
  - `45:00~89:59` -> 快进到 `90:00`
- `R`：重置比赛

> 报告弹窗显示期间，比赛控制按键会被屏蔽（比赛暂停）。

## 5. 底部按钮操作（手势）

底部按钮：`开始` / `暂停` / `重置` / `半场报告` / `全场报告`

触发规则（与其他按钮一致）：

1. 手势光标移动到按钮上方
2. 保持抓取手势 1 秒
3. 触发按钮动作

`半场报告` / `全场报告` 说明：

- 只有对应报告已生成后才可打开内容弹窗
- 未生成时会在日志提示“尚未生成（需到45:00/90:00后）”

## 6. 阵型调整（A队）

1. 抓取 A 队球员头像拖动位置
2. 形成你想要的站位后，保持 `OK` 手势 1 秒确认
3. 系统匹配到标准阵型并申请引擎变更

注意：

- 已修复“可视化先变、引擎拒绝”的口子：现在先过引擎配额，再执行可视化调整
- 若阵型配额不足，确认失败并给出提示

## 7. 策略调整（A队）

策略位于中间窄条的 `A队策略` 区域，按三组互斥：

- 高度组
- 节奏组
- 通道组

触发流程：

1. 将光标移到某个策略项
2. 抓取手势保持 0.5 秒，完成“选中”（会显示进度条）
3. 可继续选其他组项（仍会显示 0.5 秒选中进度）
4. 最后保持 `OK` 手势 1 秒，统一确认提交

确认结果：

- 成功：显示“策略确认成功”
- 失败（如配额不足）：回滚并显示失败提示

## 8. 配额规则（比赛时间窗）

每个 15 分钟比赛时间窗（非现实时间）：

- 阵型调整：`1` 次
- 策略调整：`2` 次

时间窗切换时自动重置配额。

## 9. 报告逻辑

自动触发：

- 到 `45:00` 自动触发中场报告
- 到 `90:00` 自动触发终场报告

弹窗行为：

- 报告弹窗出现时自动暂停比赛
- 自动关闭时间：`30` 秒
- 可用 `OK` 手势保持 1 秒提前关闭

再次查看：

- 报告生成后，可通过底部 `半场报告` / `全场报告` 按钮再次打开

## 10. 大模型与回退机制

报告生成优先尝试大模型调用（DashScope 兼容接口）。

- 若 `openai` 依赖缺失，或调用失败，会自动回退到本地摘要报告
- 当前代码支持读取：
  - 环境变量 `DASHSCOPE_API_KEY`
  - 若未设置，使用内置默认 Key（与状态机文件一致）

## 11. 常见问题

### 11.1 按钮难以点中

- 已增加手势映射增益与按钮命中容差
- 抓取时增加防抖，避免轻微抖动导致中断

### 11.2 抓取球员跟手慢

- 已对“拖拽球员”场景做更高响应滤波，移动速度提升

### 11.3 报告没出来

- 先看比赛时间是否达到 `45:00` / `90:00`
- 检查日志中是否出现“正在生成报告”
- 若网络不可用，会生成本地摘要报告

## 12. 建议测试流程（5分钟）

1. 启动程序后按 `M` 快进到中场，验证中场报告自动弹窗
2. 关闭报告后，再用底部 `半场报告` 按钮重新打开
3. 在 A 队策略区执行“0.5秒选中 + OK1秒确认”
4. 继续按 `M` 快进到终场，验证终场报告弹窗与关闭逻辑
