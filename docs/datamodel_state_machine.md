# 11 人制足球战术对抗数据模型（状态机视角）

本文档在原有数据模型基础上，**以状态机为主线**描述比赛如何在“球权 + 区域 + 事件”的驱动下推进，并与阵型/策略/结构对抗相连接。

---

## 1. 设计目标

- 用清晰的状态机描述“球在不同区域的攻防状态变化”
- 将阵型、策略、结构对抗、事件机制统一映射到状态转移
- 为过程解说与赛后复盘提供可追溯的事件流

---

## 2. 核心状态定义

### 2.1 球权状态

`P ∈ {A, B}`

### 2.2 区域状态（9 区 + 禁区层）

- 后场：`DZ_L / DZ_C / DZ_R`
- 中场：`MC_L / MC_C / MC_R`
- 前场：`AT_L / AT_C / AT_R`
- 禁区威胁区：`BA_L / BA_C / BA_R`
- 禁区内：`PA`

### 2.3 时间片状态

`T_k = (P_k, Z_k, t_k)`  
- `t_k` 为当前时间片索引  
- 每个时间片内阵型/策略保持不变

---

## 3. 状态机输入（来自阵型与策略）

### 3.1 阵型特征向量（8 维）

`F = [AW, DW, CN, HS, PR, BS, TR, BU]`

### 3.2 策略修正

`F' = clamp(F + Σ α_i * ΔF_i, 0, 1)`  
`Risk' = clamp(Risk + Σ α_i * ΔRisk_i, 0, 1)`

### 3.3 路线倾向先验

`W_form = [W_L, W_C, W_R]`  
- 由阵型决定，用于“左/中/右”路线选择的先验

---

## 4. 状态转移的概率组件

### 4.1 进攻过程因子

- `F_build`：出球与压迫对抗  
- `F_progress`：推进强度  
- `F_entry`：进入禁区能力  
- `F_transition`：反击与纵深  
- `F_disrupt`：防守破坏效率

### 4.2 区域推进/转移/失误

- `P_advance`：向下一纵深区域推进  
- `P_switch`：同层左右或中路转移  
- `P_loss`：失误导致球权切换  

### 4.3 射门事件

- `P_shot`：在 `BA/PA` 区域触发射门  
- `P_goal / P_save / P_block`：射门结果分解

### 4.4 规则事件

- `P_foul`：犯规（触发任意球/点球）  
- `P_out`：出界（触发界外球）  
- `P_corner`：角球（条件事件，由“出底线 + 最后触球方为防守方”派生）

---

## 5. 事件优先级与概率闭环

**优先级顺序：**
1. 犯规（Foul）  
2. 射门（Shot）  
3. 出界/角球（Out/Corner）  
4. 推进/转移/失误  
5. 原地控球（Hold）

**概率闭环约束：**

```
P_penalty = P_foul * I(Z = PA)
P_freekick = P_foul * I(Z != PA)

P_event = P_penalty + P_freekick + P_shot + P_out
P_flow  = P_advance + P_switch + P_loss
P_hold  = 1 - P_event - P_flow
```

角球不单独计入 `P_event`，在出底线事件后按规则派生，避免与 `P_out` 重复计数。

执行顺序：先分配 `P_event`，再用剩余概率分配 `P_flow`。

---

## 6. 状态转移规则（文字描述）

0. **事件回流（若触发 P_event）**：  
   - **出界（含最后触球方判定）**：  
     - 若出界源于**进攻方失误**（传球/推进失误）→ 最后触球方 = 进攻方 → 球权给防守方  
     - 若出界源于**防守方封堵/解围** → 最后触球方 = 防守方 → 球权给进攻方  
     - 出界区域回流：边路 `MC_L/MC_R` 或 `AT_L/AT_R`  
   - **角球**：发生在 `BA/PA` 且最后触球方为防守方。  
     - 触发判定：射门/传中/解围后出底线，且最后触球方为防守方。  
     - 开球区域：按出底线侧进入 `BA_L` 或 `BA_R`。  
     - 首轮结果：  
       - 若进攻方第一点占优，进入 `PA` 或保持 `BA` 形成二次进攻；  
       - 若防守方第一点占优，球回落到 `AT/MC`，可能直接形成反击；  
       - 若直接射门（`ShotType=CornerShot`），进入射门结算。  
   - **任意球**：犯规后由进攻方在犯规区域附近重启（仅 `Z != PA`）。  
     - 区域回流：`(P, Z) → (P, Z 或 Z+1 层)`，其中前移一层概率随犯规位置升高。  
     - 执行分流：  
       - **直接攻门**：若在 `AT/BA` 且角度可行，`ShotType=ShortFK/LongFK/CurledFK/KnuckleFK`，进入射门结算；  
       - **传中/做球**：落点进入 `BA/PA`，进入第一点争抢与二次进攻；  
       - **短传组织**：维持当前层继续推进（保守重启）。  
     - 防守方“人墙/站位”不需要界面手动设置，改为自动推导（仅对“直接攻门”分支生效）：  
       - `WallQuality_auto = clamp(0.55*BS_B + 0.30*PR_B + 0.15*DW_B, 0, 1)`  
       - `WallPositionFit_auto = clamp(0.50*DW_B + 0.30*PR_B + 0.20*AngleFit(FKZone), 0, 1)`  
       - `GKPosition_auto = clamp(0.60*BS_B + 0.40*PR_B, 0, 1)`  
       - 其中 `AngleFit(FKZone)` 可按区域预设：中路 `1.0`，肋部 `0.7`，边路 `0.4`。  
       - 修正项：`WallFactor = 0.6*WallQuality_auto + 0.4*WallPositionFit_auto`  
       - 概率修正：  
         - `P_block' = clamp(P_block + 0.20*WallFactor, 0, 1)`  
         - `P_save'  = clamp(P_save + 0.15*GKPosition_auto + 0.05*WallFactor, 0, 1)`  
         - `P_goal'  = clamp(1 - P_block' - P_save', 0, 1)`  
       - 若使用分解归一化流程，则将 `P_block' / P_save' / P_goal'` 再统一归一化。  
   - **点球**：仅当 `P_foul` 且 `Z = PA` 时触发：`(P, PA) → ShotType=Penalty → 进入射门结算`  
   > 事件触发时，本时间片不再执行推进/转移/失误。
1. **推进**：`(P, DZ/MC/AT) → (P, 下一层同侧区域)`  
2. **横向转移**：`(P, 同层L/C/R) → (P, 同层其他侧)`  
3. **失误**：`(A, Z) → (B, Z)` 或 `(B, Z) → (A, Z)`  
   - 默认在**原区域立即反击**，体现就地抢断后的快速推进  
   - 定义“就地反击成功概率”：
     - `P_counter = sigmoid( TR_new + Risk_new - PR_old )`
   - 若 `P_counter` 成功：  
     - 区域从 `Z` **推进一层**（如 `MC_L → AT_L`，`AT_C → BA_C`）  
   - 若 `P_counter` 失败：  
     - 维持在原区域组织（`Z` 不变）  
   - 若失误发生在 `PA` 或 `BA`：  
     - 先回落至相邻区域（`BA` 或 `AT`），再评估反击成功率
4. **射门**：`(P, BA/PA) → Shot`  
5. **进球**：球权交给对方，区域回到 `MC_C`  
6. **扑救/封堵**：在该状态下按真实足球规律将结果归为“控制 / 解围 / 二次球 / 定位球”。  
   - **控制成功**：控球方（守门员开球）完全掌控球权，  
     默认设定：`P(MC)=0.70`、`P(DZ)=0.30`（进入中场概率更高）。  
     进入 `MC_L/MC_C/MC_R` 或 `DZ_L/DZ_C/DZ_R` 后，再按控球方路线倾向加权分配左右中路。  
   - **解围成功**：守方将球送出危险区但未完全控球，球落在 `AT/MC`，形成争抢。  
   - **二次球**：球仍留在禁区或禁区威胁区，区域保持 `PA/BA`，进攻方二次机会概率上升。  
   - **定位球结果**：防守触球后出界，触发 **角球/界外球**（依据出界位置与触球方确定）。

---

## 7. 事件回流与球权变化

- **出界**：球权交换，回到边线区域  
- **角球**：球权保持，回到 `BA_L/BA_R`；第一点争抢后分流到 `PA/BA`（进攻方占优）或 `AT/MC`（防守方占优）  
- **任意球**：球权保持，区域保持或前移；可直接攻门、传中落点到 `BA/PA` 或短传重启  
- **点球**：进入射门类型 `Penalty`

---

## 8. 解说事件生成点

每次状态变化都可生成事件流条目：

- 推进成功（区域变化）
- 转移成功（横向切换）
- 失误/抢断（球权变化）
- 射门类型与结果
- 角球/任意球/点球触发

这些事件流将作为 AIGC 解说与复盘的主要输入。

---

## 9. 与整体数学模型的对齐关系

状态机所需概率与事件来自：

- **阵型层**：结构特征 F  
- **策略层**：强度修正与 Risk  
- **结构对抗层**：adv_i 与 M(A→B)  
- **过程因子层**：F_build/F_progress/F_entry/F_transition/F_disrupt  
- **射门层**：ShotType 与结果分解  

因此状态机是“数学模型”的执行载体。

---

## 10. 输出结构

状态机最终输出：

- 事件流（带时间戳）
- 区域序列（球在 9 区的迁移轨迹）
- 射门与进球序列
- 球权变化日志

这些输出既用于解说，也用于赛后分析与模型评估。
